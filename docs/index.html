<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #fcd7e6;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
    <title>Stitch Markers</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>

<body>
    <div class="container" id="mainContainer" style="overflow-y: scroll;">
        <nav class="navbar bg-body-tertiary">
            <div class="container-fluid row">
                <div class="col-6">
                    <h1 id="title" style="text-align: center;">Stitch Markers</h1>
                    <h4 id="slogan" style="text-align: center;">Knitting made easy</h4>
                </div>
                <div class="col">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        Translations
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#">Camila</a></li>
                        <li><a class="dropdown-item" href="#">Evangelina</a></li>
                        <li><a class="dropdown-item" href="#">Guidaí</a></li>
                        <li><a class="dropdown-item" href="#">Juan Manuel</a></li>
                        <li><a class="dropdown-item" href="#">Julieta</a></li>
                        <li><a class="dropdown-item" href="#">Ornella</a></li>
                        <li><a class="dropdown-item" href="#">Paula</a></li>
                    </ul>
                </div>
                <a class="navbar-brand" href="#">Default</a>
            </div>
        </nav>


        <div id="divRows" class="container">
            <div class="row" id="row1"
                style="margin-top: 5px; margin-bottom: 5px; background-color: #fce6ef; height: 50px;">
                <span style="width: min-content; height: 50px; line-height: 50px; display: none;">1</span>
            </div>
        </div>

        <div id="divButtonsGoHere" style="text-align: center;">
            <button id="addStitchButton">Add stitch</button>
            <button id="newRowButton">Add new row</button>
        </div>

        <div id="divInfo" class="divInstructions"
            style="margin-top: 20px; margin-bottom: 20px; padding-top:20px; border-top: 2px dashed #bf9fac;">
            <p>
                <span>See instructions for stitch </span>
                <select id="sel-inst">
                </select>
                <button id="btnConfirmInst">Confirm</button>
            </p>
            <div id="divInst"></div>

            <div style="margin-top: 10px;">
                <label for="stitchesInRow" style="font-weight: bold;">Total stitches: </label>
                <span id="stitchesInRow"></span>
            </div>

            <div>
                <label for="incInRow" style="font-weight: bold;">Num. increases: </label>
                <span id="incInRow"></span>
            </div>

            <div>
                <label for="decsInRow" style="font-weight: bold;">Num. decreases: </label>
                <span id="decsInRow"></span>
            </div>

        </div>
        <div id="myModal" class="modal">
            <div class="modal-content">
                <button class="close" id="btnCloseModal">Χ</button>

                <div class="center">Select a stitch</div>
                <select id="choose-sel">

                </select>

                <label for="numReps"><span id="strRepeat">Repeat</span><input type="number" min="1" value="1"
                        id="numReps"><span id="strTimes">times</span></label>
                <div id="divForBtnConfirm">
                    <button id="btnConfirmStitch">Confirm</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        let stitchCount = parseInt(0);
        let increaseCount = 0;
        let decreaseCount = 0;
        let numRows = 1;
        let stitchDefs = [];
        localStorage.setItem("stitchCount", 0);
        localStorage.setItem("increaseCount", 0);
        localStorage.setItem("decreaseCount", 0);
        localStorage.setItem("numRows", 1);
        localStorage.setItem("stitchDefs", "");

        // html object definitions
        let modal;
        let btnCloseModal;
        let selectBox;
        let addStitchButton;
        let btnConfirmStitch;
        let btnAddRow;
        let btnConfirmInst;
        let selectInstructions;

        document.onload = addListeners();

        function addListeners() {
            modal = document.getElementById("myModal");
            btnCloseModal = document.getElementById("btnCloseModal");
            selectBox = document.getElementById("choose-sel");
            addStitchButton = document.getElementById('addStitchButton');
            btnConfirmStitch = document.getElementById("btnConfirmStitch");
            btnAddRow = document.getElementById("newRowButton");
            btnConfirmInst = document.getElementById("btnConfirmInst");
            selectInstructions = document.getElementById("sel-inst");

            addStitchButton.addEventListener('click', openModal);
            btnCloseModal.addEventListener('click', closeModal);
            btnConfirmStitch.addEventListener('click', function () {
                let numReps = document.getElementById("numReps").value
                stitchCount += parseInt(numReps);
                addStitchToRow(selectBox.value, parseInt(numReps));
                document.getElementById("numReps").value = 1;
                closeModal();
                selectBox.value = "null";
            })
            btnAddRow.addEventListener('click', function () {
                numRows++;

                // create new row
                let divRows = document.getElementById("divRows");
                let newRow = document.createElement('div');
                newRow.id = ('row' + numRows).toString();
                newRow.className = 'row';
                newRow.style = 'margin-top: 5px; margin-bottom: 5px; background-color: #fce6ef; height: 50px;';

                divRows.appendChild(newRow);
            })

            loadStitches('./stringsTest.xliff');
            getStitchDefinitions();
            btnConfirmInst.addEventListener('click', showInstructions);
        }

        async function getStitchDefinitions() {
            let defsAsStrings;
            if (localStorage.getItem("stitchDefs").length == 0) {
                try {
                    let response = await fetch('./data/stitches.csv')
                        .then(response => response.text())
                        .then(data => {
                            defsAsStrings = data;
                        })
                        .catch(error => {
                            console.error('Error fetching CSV:', error);
                        });
                } catch (e) {
                    console.error("everything has gone wrong. call the authorities.")
                }
                let rows = defsAsStrings.split('\n');

                for (let i = 1; i < rows.length; i++) {
                    let properties = rows[i].split(';');
                    let stitchObject = "name:" + properties[0] + ";shortHand:" + properties[1] + ";numStitches:" + properties[2] + ";numIncreases:" + properties[3] + ";numDecreases:" + properties[4] + ";instructions:" + properties[5];
                    if (i != rows.length - 1) stitchObject += "|";

                    if (i == 1) {
                        localStorage.setItem("stitchDefs", stitchObject)
                    } else {
                        localStorage.setItem("stitchDefs", localStorage.getItem("stitchDefs") + stitchObject);
                    }
                }

            }


        }

        // load stitches to select box
        async function loadStitches(xliffPath) {
            let lanOption = "en-GB";
            try {
                const response = await fetch(xliffPath, {
                    method: "GET",
                    mode: "cors",
                    headers: {
                        "Access-Control-Allow-Origin": "*"
                    }
                });
                const xmlString = await response.text();

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, 'application/xml');

                let allStitchNames = xmlDoc.querySelectorAll("group[id='stitchNames'] > unit");
                let selectBox = document.getElementById("choose-sel");
                let selectInstructions = document.getElementById("sel-inst");
                let defaultValue = document.createElement("option");
                defaultValue.value = null;
                defaultValue.innerHTML = "Select a stitch"
                selectBox.appendChild(defaultValue);
                for (let i = 0; i < allStitchNames.length; i++) {
                    let item = allStitchNames.item(i);

                    if (document.querySelector(`option[value='${item.id}]`) == null) {
                        let value = item.id;
                        let id = "opt_" + value;
                        let innerText = item.querySelector("source").innerHTML;
                        let option = document.createElement("option");
                        option.innerText = innerText;
                        option.value = value;
                        option.id = id;
                        selectBox.appendChild(option);

                        let option2 = document.createElement("option");
                        option2.innerText = innerText;
                        option2.value = value;
                        option2.id = id;
                        selectInstructions.appendChild(option2);
                    }
                }

            } catch (error) {
                console.log(error)
            }
            return;
        }

        function addStitchToRow(stValue, numReps) {
            // I'm expecting stValue to be the id
            let stShortHand = stValue.replace("st_n_", "");
            let allStitches = localStorage.getItem("stitchDefs").split('|');
            let fullSt;
            for (let i = 0; i < allStitches.length && !fullSt; i++) {
                fullSt = allStitches[i].split(';');
                if (fullSt[1].replace("shortHand:", "") != stShortHand) fullSt = null;
            }

            let activeRow = document.getElementById(('row' + numRows).toString());
            let img = document.createElement("img");
            img.src = "symbols/" + fullSt[1].replace("shortHand:", "") + ".jpg";
            img.style = "width: 50px; height: 50px; padding: 2px;"
            for (let i = 0; i < numReps; i++) {
                document.getElementById(activeRow.id).appendChild(img.cloneNode())
            }
        }

        function showInstructions() {
            let selectedStitch = document.getElementById("sel-inst").value;
            selectedStitch = selectedStitch.replace("st_n_", "");
            let splitDefinitions = localStorage.getItem("stitchDefs").split('|');
            let splitStitch;

            for (let i = 0; i < splitDefinitions.length && !splitStitch; i++) {
                let currentSt = String(splitDefinitions[i]);
                if (currentSt.includes(String("shortHand:" + selectedStitch))) {
                    splitStitch = currentSt.split(';');
                    let instructions = String(splitStitch[5]).replace("instructions:", "");
                    instructions = instructions.replace('"', '');
                    document.getElementById("divInst").innerHTML = instructions;

                    document.getElementById("stitchesInRow").innerHTML = String(splitStitch[2]).replace("numStitches:", "");
                    document.getElementById("incInRow").innerHTML = String(splitStitch[3]).replace("numIncreases:", "");
                    document.getElementById("decsInRow").innerHTML = String(splitStitch[4]).replace("numDecreases:", "");
                }
            }
        }

        function getShortHand(str) {
            let aux = str.split("symbols/");
            str = str.replace("symbols/", "");
            str = str.replace(".jpg", "");
            return str;
        }

        function closeModal() {
            if (modal.style.display != 'none') modal.style.display = 'none';
        }

        function openModal() {
            modal.style.display = "block";

            let stitchList = [];
            for (let i = 0; i < 5; i++) {
                stitchList.push(stitchDefs[0])
            }
            for (let i = 0; i < 2; i++) {
                stitchList.push(stitchDefs[3])
            }
        }


    </script>

</body>

</html>